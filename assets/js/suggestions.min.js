var TDC=TDC||{suggestions:[]};!function(){var $=jQuery;TDC.instances=TDC.instances||{};var BaseView=Backbone.View.extend({initialize:function(options){return Backbone.View.prototype.initialize.apply(this,arguments),this.controller=options.controller?options.controller:null,this},showSpinner:function(){this.$el.find(".spinner").css("display","inline-block"),this.$el.find(".spinner").css("visibility","visible")},hideSpinner:function(){this.$el.find(".spinner").css("display","none"),this.$el.find(".spinner").css("visibility","hidden")}}),TaxonomySelector=BaseView.extend({events:{"change input":"change"},initialize:function(options){return this.suggestion_list=options.suggestion_list,BaseView.prototype.initialize.apply(this,arguments),this.suggestion_list.suggestion_form.on("suggestionsPopulated",this.enable.bind(this)),this},disable:function(){this.$el.find("input").attr("disabled","disabled")},enable:function(){this.$el.find("input").removeAttr("disabled")},change:function(event){var target=$(event.currentTarget);return TDC.taxonomy=target.val(),this.trigger("taxonomy_changed"),!1}}),GenerateSuggestions=BaseView.extend({events:{"click a.tdc-generate-suggestions":"generateSuggestions"},page:1,initialize:function(){return BaseView.prototype.initialize.apply(this,arguments),TDC.instances.suggestion_list.suggestion_form.on("suggestionsPopulated",this.suggestionsPopulated.bind(this)),this},generateSuggestions:function(event){var self=this;if(void 0!==event&&$(event.currentTarget).hasClass("disabled"))return!1;if(void 0!==event&&"click"==event.type&&void 0!==self.ongoing&&-1==$.inArray(self.ongoing.state(),["resolved","rejected"]))return!1;var opts={url:ajaxurl,data:{action:"tdc_ajax_generate_consolidation_suggestions",security:TDC.ajax_nonce,request:JSON.stringify({taxonomy:TDC.taxonomy,page:self.page})},dataType:"json",method:"post",success:function(data){data.suggestions.page==data.suggestions.totalPages?(self.updateProgress(100),self.hideProgress(),self.page=1,self.fetchSuggestions()):(self.updateProgress(data.suggestions.page/data.suggestions.totalPages*100),self.page+=1,self.generateSuggestions())}};return self.clearSuggestionList(),self.disableButton(),self.showProgress(),self.showSpinner(),self.ongoing=$.ajax(opts),!1},updateProgress:function(value){this.$el.find(".tdc-generate-suggestions-progress").progressbar({value:value})},showProgress:function(){this.$el.find(".tdc-generate-suggestions-progress").progressbar().show()},hideProgress:function(){this.$el.find(".tdc-generate-suggestions-progress").progressbar("destroy").hide()},disableButton:function(){this.$el.find(".tdc-generate-suggestions").addClass("disabled")},enableButton:function(){this.$el.find(".tdc-generate-suggestions").removeClass("disabled")},clearSuggestionList:function(){if(void 0!==TDC.instances.suggestion_list){var suggestion_list=TDC.instances.suggestion_list;suggestion_list.$el.html(""),suggestion_list.pagination&&suggestion_list.pagination.hide()}},fetchSuggestions:function(){TDC.instances.suggestion_list.suggestion_form.getSuggestions()},suggestionsPopulated:function(){this.hideSpinner(),this.enableButton()}}),SuggestionForm=BaseView.extend({events:{"click .submit":"getSuggestions"},getSuggestions:function(event){var self=this;if(void 0!==event&&"click"==event.type&&void 0!==self.ongoing&&-1==$.inArray(self.ongoing.state(),["resolved","rejected"]))return!1;var opts={url:ajaxurl,data:{action:"tdc_ajax_get_consolidation_suggestions",security:TDC.ajax_nonce,request:JSON.stringify({taxonomy:TDC.taxonomy,page:self.controller.page})},dataType:"json",method:"post",success:function(data){self.trigger("suggestionsPopulated",data),self.hideSpinner(),self.hideFetching()}};return self.controller.pagination&&self.controller.pagination.showSpinner(),self.showFetching(),self.showSpinner(),self.ongoing=$.ajax(opts),!1},showFetching:function(){this.$el.find(".fetching").show()},hideFetching:function(){this.$el.find(".fetching").hide()}}),SuggestionList=BaseView.extend({page:1,data:{},initialize:function(attributes,options){return Backbone.View.prototype.initialize.apply(this,arguments),this.suggestion_form=new SuggestionForm({el:"#tdc-fetching-suggestions",controller:this}),this.suggestion_form.on("suggestionsPopulated",this.render.bind(this)),this},render:function(data){var self=this;return self.$el.html(""),_.each(data.suggestions.groups,function(group,i){var templateId=group.length<=1?"#tdc-no-suggestion-tmpl":"#tdc-suggestion-tmpl",suggestion=new SuggestionView({template:_.template($(templateId).html()),group:group,controller:self});suggestion.render(),self.$el.append(suggestion.$el)}),this.pagination||(this.pagination=new SuggestionsPagination({el:"#tdc-pagination-container",controller:this})),this.data=data,this.pagination.render(),!1}}),SuggestionsPagination=BaseView.extend({events:{"click a.next":"next","click a.prev":"prev"},render:function(){this.hideSpinner();var attrs=void 0===this.controller.data.suggestions?{}:this.controller.data.suggestions;if(this.$el.html(""),this.$el.append(_.template($("#tdc-pagination-tmpl").html())({})),void 0===attrs.totalPages)return this;attrs.page<=1?this.$el.find(".prev").addClass("disabled"):this.$el.find(".prev").removeClass("disabled"),attrs.totalPages>1&&this.$el.find(".next").removeClass("disabled"),attrs.page>=attrs.totalPages&&this.$el.find(".next").addClass("disabled"),this.updateCount(),this.show()},next:function(){return this.controller.page=this.controller.page+1,this.controller.suggestion_form.getSuggestions(),!1},prev:function(){return this.controller.page=this.controller.page-1,this.controller.suggestion_form.getSuggestions(),!1},updateCount:function(){var attrs=void 0===this.controller.data.suggestions?{}:this.controller.data.suggestions;this.$el.find(".tdc-page").html(attrs.page),this.$el.find(".tdc-total-pages").html(attrs.totalPages)},hide:function(){this.$el.hide()},show:function(){this.$el.show()}}),SuggestionView=BaseView.extend({className:"tdc-suggestion",events:{"click a.tdc-apply-consolidation":"applyConsolidation","click a.tdc-dismiss-suggestion":"dismiss","click a.tdc-make-primary":"updatePrimary","click a.tdc-remove-term":"removeTerm"},initialize:function(options){return BaseView.prototype.initialize.apply(this,arguments),this.template=options.template,this.group=options.group,this},render:function(){this.$el.html("");var terms="";return this.group.length<=1?this.$el.append(this.template({term:this.group[0]})):(_.each(this.group,function(term,idx){terms+=0==idx?_.template($("#tdc-primary-term-tmpl").html())({term:term}):_.template($("#tdc-secondary-term-tmpl").html())({term:term})}),this.$el.append(this.template({terms:terms}))),this},displayMessage:function(data){this.hideSpinner(),this.$el.html(""),this.$el.html("<p>"+data.message+"</p>")},applyConsolidation:function(){var self=this,form=this.$el.find("form"),term_ids=form.find('input[name="term_ids[]"]').map(function(idx,ele){return $(ele).val()}).get(),primary_term=form.find('input[name="primary_term_id"]').val();return this.showSpinner(),this.request("apply",{primary_term:primary_term,term_ids:term_ids,taxonomy:TDC.taxonomy},function(data){self.displayMessage(data),self.controller.suggestion_form.getSuggestions()}),!1},dismiss:function(){var self=this,primary_term=this.$el.find("form").find('input[name="primary_term_id"]').val();return this.showSpinner(),this.request("dismiss",{primary_term:primary_term,taxonomy:TDC.taxonomy},function(data){self.displayMessage(data),self.controller.suggestion_form.getSuggestions()}),!1},updatePrimary:function(event){var index,target_term_id=$(event.currentTarget).data("term-id");_.each(this.group,function(v,i){v.term_id!=target_term_id||(index=i)});var new_primary=this.group.splice(index,1);return this.group.unshift(new_primary[0]),this.render(),!1},removeTerm:function(event){return $(event.currentTarget).parent().parent().parent().remove(),!1},request:function(type,data,success){var self=this;if(!type)return!1;if(void 0!==self.ongoing&&-1==$.inArray(self.ongoing.state(),["resolved","rejected"]))return!1;var opts={url:ajaxurl,data:{action:"tdc_ajax_"+type+"_consolidation_suggestions",security:TDC.ajax_nonce,request:JSON.stringify(data)},dataType:"json",method:"post",success:function(data){void 0!==success&&success(data)}};return self.showSpinner(),self.ongoing=$.ajax(opts),!1}});$(document).ready(function(){TDC.instances.suggestion_list=new SuggestionList({el:"#tdc-suggestions-list"}),TDC.instances.generate_button=new GenerateSuggestions({el:"#tdc-suggestions-request"}),TDC.instances.tax_selector=new TaxonomySelector({el:"#tdc-tax-selector",suggestion_list:TDC.instances.suggestion_list});var initialSetup=function(){TDC.instances.suggestion_list.$el.html(""),void 0!==TDC.instances.suggestion_list.pagination&&TDC.instances.suggestion_list.pagination.hide(),TDC.existing[TDC.taxonomy]&&(TDC.instances.tax_selector.disable(),TDC.instances.generate_button.disableButton(),TDC.instances.generate_button.showSpinner(),TDC.instances.generate_button.fetchSuggestions())};TDC.instances.tax_selector.on("taxonomy_changed",function(event){initialSetup()}),initialSetup()})}();